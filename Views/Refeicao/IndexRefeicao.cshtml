@model ProjetoNutri.Models.ProjetoDietaViewModel

<h2 class="mb-4 text-primary text-center texto">üçΩÔ∏è Minhas Refei√ß√µes</h2>

<!-- Bot√µes de a√ß√£o -->
<div class="mt-4 d-flex justify-content-between">
    <a asp-action="DetalheProjeto" asp-controller="Projeto" asp-route-id="@Model.Projeto.Id" class="btn btn-secondary">
        Voltar
    </a>
    <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalCriarRefeicao">+ Nova Refei√ß√£o</button>
    <a asp-controller="Pdf" asp-action="GerarPdf" asp-route-idProjeto="@Model.Projeto.Id" class="btn btn-secondary">
        üìÑ Gerar PDF
    </a>
</div>

<br />

<!-- Modal de cria√ß√£o de refei√ß√£o -->
<div class="modal fade" id="modalCriarRefeicao" tabindex="-1" aria-labelledby="modalCriarRefeicaoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-secondary" id="modalCriarRefeicaoLabel">Criar Nova Refei√ß√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form asp-action="CriarRefeicao" method="post">
          <div asp-validation-summary="ModelOnly" class="text-danger"></div>
          <div class="form-group">
            <label asp-for="Refeicao.Nome" class="control-label fw-bold"></label>
            <input asp-for="Refeicao.Nome" class="form-control" placeholder="Nome da Refei√ß√£o" />
            <span asp-validation-for="Refeicao.Nome" class="text-danger"></span>
          </div>
          <input type="hidden" name="Refeicao.IdProjeto" value="@Model.Projeto.Id" />
          <div class="modal-footer mt-3">
            <button type="submit" class="btn btn-secondary">Criar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Resumo Nutricional Geral -->
<div class="card p-3 mb-4 shadow-sm cor">
    <h4 class="text-primary text-center texto">Resumo Nutricional</h4><br>
    <div class="row text-center">
        <div class="col"><p><strong>üí™ Prote√≠na:</strong> @Model.TotalProteinaGeral.ToString("F2") g</p></div>
        <div class="col"><p><strong>ü•ì Lip√≠dio:</strong> @Model.TotalLipidioGeral.ToString("F2") g</p></div>
        <div class="col"><p><strong>üçû Carboidrato:</strong> @Model.TotalCarboidratoGeral.ToString("F2") g</p></div>
        <div class="col"><p><strong>üî• Energia:</strong> @Model.TotalKcalGeral.ToString("F2") kcal</p></div>
    </div>
</div>

<!-- Lista de Refei√ß√µes -->
<div id="sortableRefeicoes" class="list-group">
    @foreach (var refeicao in Model.Refeicaos)
    {
        <div class="list-group-item refeicao-item shadow-sm p-3 mb-3 bg-white rounded" data-id="@refeicao.Id">
            <div class="refeicao-header d-flex align-items-center flex-wrap gap-3 mb-3">
                <input type="text" class="refeicao-nome-custom" value="@refeicao.Nome" data-refeicao-id="@refeicao.Id" />
                <div class="nutriente-box"><div class="nutriente-titulo">üí™ <span class="nomespan">Prote√≠na</span></div><div class="nutriente-valor">@Model.TotalProteinaPorRefeicao[refeicao.Id].ToString("F2") g</div></div>
                <div class="nutriente-box"><div class="nutriente-titulo">ü•ì <span class="nomespan">Lip√≠dio</span></div><div class="nutriente-valor">@Model.TotalLipidioPorRefeicao[refeicao.Id].ToString("F2") g</div></div>
                <div class="nutriente-box"><div class="nutriente-titulo">üçû <span class="nomespan">Carboidrato</span></div><div class="nutriente-valor">@Model.TotalCarboidratoPorRefeicao[refeicao.Id].ToString("F2") g</div></div>
                <div class="nutriente-box"><div class="nutriente-titulo">üî• <span class="nomespan">Energia</span></div><div class="nutriente-valor">@Model.TotalKcalPorRefeicao[refeicao.Id].ToString("F2") kcal</div></div>
                <div class="acoes-refeicao d-flex gap-2">
                    <a asp-action="DuplicarRefeicao" asp-controller="Refeicao" asp-route-id="@refeicao.Id" class="btn-editar-excluir" title="Duplicar Refei√ß√£o"><i class="bi bi-back"></i></a>
                    <form id="form-excluir-@refeicao.Id" asp-action="Deletar_Refeicao" asp-controller="Refeicao" asp-route-id="@refeicao.Id" method="post">
                        <button type="submit" class="btn-editar-excluir btn-excluir" data-refeicao-id="@refeicao.Id" title="Excluir Refei√ß√£o"><i class="bi bi-trash2-fill"></i></button>
                    </form>
                </div>
            </div>
            @if (refeicao.Refeicao_Alimentos != null && refeicao.Refeicao_Alimentos.Any())
            {
                <table class="table table-bordered mt-3">
                    <thead class="table-light text-center">
                        <tr><th>üçè Alimento</th><th>üìè Quantidade (g)</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var refeicaoAlimento in refeicao.Refeicao_Alimentos)
                        {
                            <tr class="text-center">
                                <td><strong>@refeicaoAlimento.Alimento.Nome</strong></td>
                                <td>@((refeicaoAlimento.Quantidade / 1000).ToString("F3")) g</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-center text-muted">Nenhum alimento adicionado.</p>
            }
            <div class="text-center mt-3">
                <a asp-action="CriarRefeicao_Alimento"
                   asp-controller="Refeicao_Alimento"
                   asp-route-refeicaoId="@refeicao.Id"
                   asp-route-idProjeto="@Model.Projeto.Id"
                   class="btn btn-outline-dark">
                    ‚ûï Adicionar Alimento
                </a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Carregar ordem salva
            function carregarOrdem() {
                let ordemSalva = localStorage.getItem("ordemRefeicoes");
                if (ordemSalva) {
                    let ordem = JSON.parse(ordemSalva);
                    let container = $("#sortableRefeicoes");
                    ordem.forEach(function (id) {
                        let item = container.find(`.refeicao-item[data-id='${id}']`);
                        container.append(item);
                    });
                }
            }

            // Ativar sortable
            $("#sortableRefeicoes").sortable({
                placeholder: "ui-state-highlight",
                update: function () {
                    let ordemAtual = [];
                    $(".refeicao-item").each(function () {
                        ordemAtual.push($(this).attr("data-id"));
                    });
                    localStorage.setItem("ordemRefeicoes", JSON.stringify(ordemAtual));
                }
            }).disableSelection();

            carregarOrdem();

            // Excluir refei√ß√£o
            $('.btn-excluir').click(function (event) {
                event.preventDefault();
                const id = $(this).data('refeicao-id');
                const confirmar = confirm("Tem certeza que deseja excluir esta refei√ß√£o?");
                if (confirmar) {
                    removerRefeicaoDoLocalStorage(id);
                    $('#form-excluir-' + id).submit();
                }
            });

            function removerRefeicaoDoLocalStorage(id) {
                let ordemSalva = localStorage.getItem("ordemRefeicoes");
                if (ordemSalva) {
                    let ordem = JSON.parse(ordemSalva);
                    ordem = ordem.filter(rid => rid != id);
                    localStorage.setItem("ordemRefeicoes", JSON.stringify(ordem));
                }
            }

            // Salvar nome ao pressionar Enter
            $('.refeicao-nome-custom').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    salvarNome($(this));
                    $(this).blur();
                }
            });

            function salvarNome(input) {
                let id = input.data('refeicao-id');
                let novoNome = input.val();
                $.post('/Refeicao/AtualizarNome', { id: id, nome: novoNome })
                    .fail(function () {
                        alert("Erro ao salvar o nome da refei√ß√£o.");
                    });
            }
        });
    </script>
}
